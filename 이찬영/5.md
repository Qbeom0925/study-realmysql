5장에서는 MySQL의 동시성에 영향을 미치는 잠금(Lock)과 트랜잭션, 트랜잭션 격리 수준(Isolation Level)을 살펴보겠다.

트랜잭션은 작업의 완전성을 보장해 줌.  
즉 논리적인 작업 셋을 모두 완변하게 처리하거나, 처리하지 못할 경우에는 원 상태로 복구해서 작업의 일부만 적용되는 현상(Patial update)를 막는다.  
잠금 : 동시성을 제어하기 위한 기능  
트랜잭션 : 데이터의 정합성을 보장하기 위한 기능  
격리 수준 : 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것인지를 결정하는 레벨
트랜잭션과 잠금은 비슷한 것 같지만 다르다.

ex)  
하나의 회원정보 레코드를 여러 커넥션에서 동시에 변경 시도

잠금이 없는 경우 :

- 여러 커넥션에서 동시에 변경 가능.
- 결과적으로 해당 레코드의 값은 예측할 수 없게 됨.

잠금이 있는 경우 :

- 잠금이 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에는 하나으 커넥션만 변경하게 해줌

# 5.1 트랜잭션

트랜잭션을 지원하지 않는 MyISAM과 트랜잭션을 지원하는 InnoDB의 처리 방식의 차이를 살펴보고, 트랜잭션을 사용할 경우 주의할 사항도 함께 살펴보자.

## 5.1.1 MySQL에서의 트랜잭션

트랜잭션은 하나의 논리적인 작업 셋에 하나의 쿼리가 있든 두 개의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나(COMMIT) 아무것도 적용되지 말아야 함(ROLLBACK)을 보장해주는 것이다.

트랜잭션 관점에서 InnoDB와 MyISAM의 차이를 예제로 살펴보자.
테이블MYISAM, 테이블INNODB라는 테이블은 id라는 INT타입의 레코드를 각각 갖는다고 해보자.
그래서 아래와 같은 쿼리를 수행한다.

> mysql > insert into 테이블MYISAM (id) values (3);
> mysql > insert into 테이블INNODB (id) values (3);

위의 결과는 당연하게도 id 값이 3인 레코드들이 잘 들어갈 것이다.

그런데 아래와 같은 sql을 실행한다고 해보자.

> mysql > insert into 테이블MYISAM (id) values (1), (2), (3);  
> ERROR 1062 (23000): Duplicate entry "3' for key 'PRIMARY'
>
> mysql > insert into 테이블INNODB (id) values (1), (2), (3);
> ERROR 1062 (23000): Duplicate entry "3' for key 'PRIMARY'

위 쿼리의 결과는 당연히 pk값인 3이 이전에 insert한 데이터와 중복되었기 때문에 에러가 발생할 것이다.

하지만 테이블을 조회해보면 아래와 같다.

> mysql > select \* from 테이블MYISAM;  
> +----+  
> | id |  
> +----+  
> | 1 |  
> +----+  
> | 2 |  
> +----+  
> | 3 |  
> +----+

> mysql > select \* from 테이블INNODB;  
> +----+  
> | id |  
> +----+  
> | 1 |  
> +----+

결과를 보면 MYISAM 테이블은 오류가 발생했음에도 1과 2가 insert되었다.  
이는 insert문이 실행되면서 1과 2는 차례대로 저장하고, 3을 저장하려는 순간 에러가 발생하게 된 것이다.  
하지만 MyISAM은 트랜잭션의 개념이 없기 때문에 1과 2는 그대로 저장된다.

하지만 InnoDB는 쿼리 중 일부라도 오류가 발생하면 전체를 원 상태로 만드는 트랜잭션의 원칙대로 insert문을 실행하기 전 상태로 복구했다.

MyISAM의 이러한 현상을 부분 업데이트(Partial update)라고 하며 이는 테이블 데이터의 정합성을 맞추는 것을 어렵게 한다.  
부분 업데이트 현상이 발생하면 실패한 쿼리로 인해 남은 레코드를 다시 삭제해야 하는 대처리 작업이 필요할 수 있다. 실행한 쿼리가 하나뿐이라면 재처리 작업이 간단하겠지만 2개 이상의 쿼리가 실행되는 경우라면 실패에 대한 재처리 작업이 복잡해질 것이다.
